// Circly App JavaScript

// Ï†ÑÏó≠ ÏÉÅÌÉú
let currentTab = 'home';
let polls = [
    {
        id: 1,
        question: "Í∞ÄÏû• ÏûòÏÉùÍ∏¥ ÏÇ¨ÎûåÏùÄ?",
        circleId: 1,
        circleName: "3ÌïôÎÖÑ 2Î∞ò",
        timeLeft: "2ÏãúÍ∞Ñ 30Î∂Ñ",
        totalVotes: 18,
        hasVoted: false,
        options: [
            { name: "ÎØºÏàò", votes: 8, percentage: 44 },
            { name: "ÏßÄÌõà", votes: 5, percentage: 28 },
            { name: "ÌÉúÌòÑ", votes: 3, percentage: 17 },
            { name: "ÏäπÌò∏", votes: 2, percentage: 11 }
        ]
    },
    {
        id: 2,
        question: "Í∞ÄÏû• ÏπúÏ†àÌïú ÏÇ¨ÎûåÏùÄ?",
        circleId: 1,
        circleName: "3ÌïôÎÖÑ 2Î∞ò",
        timeLeft: "ÏôÑÎ£å",
        totalVotes: 22,
        hasVoted: true,
        options: [
            { name: "ÏÑúÏó∞", votes: 12, percentage: 55 },
            { name: "ÎØ∏ÎÇò", votes: 6, percentage: 27 },
            { name: "ÏùÄÏßÄ", votes: 4, percentage: 18 }
        ]
    }
];

const questionTemplates = {
    Ïô∏Î™®: [
        "Í∞ÄÏû• ÏûòÏÉùÍ∏¥ ÏÇ¨ÎûåÏùÄ?",
        "Í∞ÄÏû• ÏòàÏÅú ÏÇ¨ÎûåÏùÄ?",
        "Ïò§Îäò Ìå®ÏÖòÏù¥ Í∞ÄÏû• Î©ãÏßÑ ÏÇ¨ÎûåÏùÄ?",
        "ÎØ∏ÏÜåÍ∞Ä Í∞ÄÏû• ÏòàÏÅú ÏÇ¨ÎûåÏùÄ?"
    ],
    ÏÑ±Í≤©: [
        "Í∞ÄÏû• ÏπúÏ†àÌïú ÏÇ¨ÎûåÏùÄ?",
        "Í∞ÄÏû• Ïû¨Î∞åÎäî ÏÇ¨ÎûåÏùÄ?",
        "Í∞ÄÏû• Îì†Îì†Ìïú ÏÇ¨ÎûåÏùÄ?",
        "Í∞ÄÏû• Ïú†ÏæåÌïú ÏÇ¨ÎûåÏùÄ?"
    ],
    Ïû¨Îä•: [
        "Í∞ÄÏû• ÎòëÎòëÌïú ÏÇ¨ÎûåÏùÄ?",
        "Ïö¥ÎèôÏùÑ Í∞ÄÏû• ÏûòÌïòÎäî ÏÇ¨ÎûåÏùÄ?",
        "ÎÖ∏ÎûòÎ•º Í∞ÄÏû• ÏûòÌïòÎäî ÏÇ¨ÎûåÏùÄ?",
        "Í∑∏Î¶ºÏùÑ Í∞ÄÏû• Ïûò Í∑∏Î¶¨Îäî ÏÇ¨ÎûåÏùÄ?"
    ]
};

// DOMÏù¥ Î°úÎìúÎêú ÌõÑ Ïã§Ìñâ
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    setupEventListeners();
});

// Ïï± Ï¥àÍ∏∞Ìôî
function initializeApp() {
    switchTab('home');
    updatePollDisplay();
    
    // Ïã§ÏãúÍ∞Ñ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÎÆ¨Î†àÏù¥ÏÖò
    setInterval(updateTimeDisplay, 60000);
}

// Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
function setupEventListeners() {
    // Î™®Îã¨ Î∞∞Í≤Ω ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            closeAllModals();
        }
    });

    // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });

    // Î≥µÏÇ¨ Î≤ÑÌäº Í∏∞Îä•
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            copyToClipboard(this);
        });
    });
}

// ÌÉ≠ Ï†ÑÌôò
function switchTab(tabName) {
    // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏïÑÏù¥ÌÖú ÏóÖÎç∞Ïù¥Ìä∏
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');

    // ÌÉ≠ ÏΩòÌÖêÏ∏† ÏóÖÎç∞Ïù¥Ìä∏
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}Tab`).classList.add('active');

    currentTab = tabName;

    // Î©îÏù∏ ÏΩòÌÖêÏ∏† Ïï†ÎãàÎ©îÏù¥ÏÖò
    const mainContent = document.getElementById('mainContent');
    mainContent.classList.add('fade');
    
    setTimeout(() => {
        mainContent.classList.remove('fade');
    }, 150);
}

// Ìà¨Ìëú ÏÉÅÏÑ∏ Î™®Îã¨ Ïó¥Í∏∞
function openPollModal(pollId) {
    const poll = polls.find(p => p.id === pollId);
    if (!poll) return;

    const modal = document.getElementById('pollModal');
    const modalHeader = modal.querySelector('.modal-header');
    
    // Î™®Îã¨ ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
    modalHeader.querySelector('h2').textContent = poll.question;
    modalHeader.querySelector('p').textContent = poll.circleName;
    modalHeader.querySelector('.time-info span').textContent = `${poll.timeLeft} ÎÇ®Ïùå`;

    // ÏòµÏÖò Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    const optionList = modal.querySelector('.option-list');
    optionList.innerHTML = poll.options.map(option => `
        <button class="option-item" onclick="vote(${pollId}, '${option.name}')">
            <span>${option.name}</span>
            <i class="fas fa-arrow-right"></i>
        </button>
    `).join('');

    showModal('pollModal');
}

// Ìà¨ÌëúÌïòÍ∏∞
function vote(pollId, optionName) {
    const poll = polls.find(p => p.id === pollId);
    if (!poll) return;

    // Ìà¨Ìëú Ï≤òÎ¶¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò
    showLoadingFeedback();
    
    setTimeout(() => {
        poll.hasVoted = true;
        poll.totalVotes++;
        
        // ÏÑ†ÌÉùÎêú ÏòµÏÖò Ìà¨ÌëúÏàò Ï¶ùÍ∞Ä
        const option = poll.options.find(opt => opt.name === optionName);
        if (option) {
            option.votes++;
        }
        
        // ÌçºÏÑºÌÖåÏù¥ÏßÄ Ïû¨Í≥ÑÏÇ∞
        poll.options.forEach(opt => {
            opt.percentage = Math.round((opt.votes / poll.totalVotes) * 100);
        });

        // ÏòµÏÖòÏùÑ Ìà¨ÌëúÏàò Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
        poll.options.sort((a, b) => b.votes - a.votes);

        updatePollDisplay();
        closePollModal();
        showSuccessFeedback('Ìà¨ÌëúÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! üéâ');
        
        // Í≤∞Í≥º Î≥¥Í∏∞Î°ú ÏûêÎèô Ï†ÑÌôò
        setTimeout(() => {
            showResultCard(pollId);
        }, 1000);
    }, 1000);
}

// Ï¥àÎåÄ Î™®Îã¨ Ïó¥Í∏∞
function showInviteModal() {
    showModal('inviteModal');
}

// Í≤∞Í≥º Ïπ¥Îìú Î™®Îã¨ Ïó¥Í∏∞
function showResultCard(pollId = 2) {
    const poll = polls.find(p => p.id === pollId);
    if (!poll) return;

    const modal = document.getElementById('resultModal');
    const resultCard = modal.querySelector('.result-card');
    
    // Í≤∞Í≥º Ïπ¥Îìú ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
    resultCard.querySelector('h3').textContent = poll.question;
    
    const winner = poll.options[0];
    const winnerElement = resultCard.querySelector('.winner');
    winnerElement.querySelector('.winner-name').textContent = winner.name;
    winnerElement.querySelector('.winner-percentage').textContent = `(${winner.percentage}%)`;
    
    // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    const chart = resultCard.querySelector('.result-chart');
    chart.innerHTML = poll.options.slice(0, 3).map((option, index) => {
        const colors = ['var(--pink-400)', 'var(--purple-400)', 'var(--blue-400)'];
        return `
            <div class="chart-item">
                <span class="name">${option.name}</span>
                <div class="bar-container">
                    <div class="bar" style="width: ${option.percentage}%; background: ${colors[index]};"></div>
                </div>
                <span class="percentage">${option.percentage}%</span>
            </div>
        `;
    }).join('');
    
    // Ï¥ù Ï∞∏Ïó¨Ïûê Ïàò ÏóÖÎç∞Ïù¥Ìä∏
    resultCard.querySelector('.result-footer').textContent = `Ï¥ù ${poll.totalVotes}Î™Ö Ï∞∏Ïó¨ ‚Ä¢ circly.app`;
    
    showModal('resultModal');
    
    // Ï∞®Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò
    setTimeout(() => {
        const bars = modal.querySelectorAll('.bar');
        bars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
    }, 200);
}

// ÏßàÎ¨∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù
function showQuestions(category) {
    const questions = questionTemplates[category];
    if (!questions) return;

    // Í∞ÑÎã®Ìïú ÏßàÎ¨∏ ÏÑ†ÌÉù ÏãúÎÆ¨Î†àÏù¥ÏÖò
    const selectedQuestion = questions[Math.floor(Math.random() * questions.length)];
    
    showLoadingFeedback();
    
    setTimeout(() => {
        showSuccessFeedback(`"${selectedQuestion}" Ìà¨ÌëúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§! üéâ`);
        switchTab('home');
    }, 1500);
}

// Î™®Îã¨ ÌëúÏãú
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

// Î™®Îã¨ Îã´Í∏∞
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
}

// Î™®Îì† Î™®Îã¨ Îã´Í∏∞
function closeAllModals() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('show');
    });
    document.body.style.overflow = 'auto';
}

// Í∞úÎ≥Ñ Î™®Îã¨ Îã´Í∏∞ Ìï®ÏàòÎì§
function closePollModal() {
    closeModal('pollModal');
}

function closeInviteModal() {
    closeModal('inviteModal');
}

function closeResultModal() {
    closeModal('resultModal');
}

// ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
function copyToClipboard(button) {
    const text = button.closest('.invite-option').querySelector('.invite-url, .invite-code').textContent;
    
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback(button);
        });
    } else {
        // Ìè¥Î∞±: ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù Î∞©Ïãù
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopyFeedback(button);
    }
}

// Î≥µÏÇ¨ ÏÑ±Í≥µ ÌîºÎìúÎ∞±
function showCopyFeedback(button) {
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Î≥µÏÇ¨Îê®';
    button.style.color = 'var(--green-500)';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.color = 'var(--purple-500)';
    }, 2000);
}

// ÏÑ±Í≥µ ÌîºÎìúÎ∞± ÌëúÏãú
function showSuccessFeedback(message) {
    const feedback = document.createElement('div');
    feedback.className = 'success-feedback';
    feedback.textContent = message;
    document.body.appendChild(feedback);
    
    setTimeout(() => {
        feedback.remove();
    }, 3000);
}

// Î°úÎî© ÌîºÎìúÎ∞± ÌëúÏãú
function showLoadingFeedback() {
    document.querySelectorAll('.btn-primary, .btn-vote, .option-item').forEach(btn => {
        btn.classList.add('loading');
        btn.disabled = true;
    });
    
    setTimeout(() => {
        document.querySelectorAll('.loading').forEach(element => {
            element.classList.remove('loading');
            element.disabled = false;
        });
    }, 1500);
}

// Ìà¨Ìëú Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
function updatePollDisplay() {
    // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî ÏÑúÎ≤ÑÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏôÄÏïº Ìï®
    // Ïó¨Í∏∞ÏÑúÎäî ÏãúÎÆ¨Î†àÏù¥ÏÖòÏùÑ ÏúÑÌïú ÏΩîÎìú
}

// ÏãúÍ∞Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
function updateTimeDisplay() {
    // Ïã§ÏãúÍ∞Ñ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ
    // Ïã§Ï†ú Íµ¨ÌòÑÏóêÏÑúÎäî ÏÑúÎ≤Ñ ÏãúÍ∞ÑÍ≥º ÎèôÍ∏∞Ìôî ÌïÑÏöî
}

// SNS Í≥µÏú† Í∏∞Îä•
function shareToInstagram() {
    // Instagram Web API ÎòêÎäî ÎÑ§Ïù¥Ìã∞Î∏å Ïï± Ïó∞Îèô
    showSuccessFeedback('InstagramÏúºÎ°ú Í≥µÏú†ÎêòÏóàÏäµÎãàÎã§! üì∏');
}

function shareToKakao() {
    // Ïπ¥Ïπ¥Ïò§ÌÜ° SDK Ïó∞Îèô
    showSuccessFeedback('Ïπ¥Ïπ¥Ïò§ÌÜ°ÏúºÎ°ú Í≥µÏú†ÎêòÏóàÏäµÎãàÎã§! üí¨');
}

// Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•
function saveResultImage() {
    // Canvas APIÎ•º ÏÇ¨Ïö©Ìïú Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î∞è Ï†ÄÏû•
    showSuccessFeedback('Ïù¥ÎØ∏ÏßÄÍ∞Ä Í∞§Îü¨Î¶¨Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! üì±');
}

// ÏóêÎü¨ Ï≤òÎ¶¨
function handleError(error) {
    console.error('Circly App Error:', error);
    showSuccessFeedback('Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî üîÑ');
}

// Í∞úÎ∞úÏûê ÎèÑÍµ¨Ïö© ÎîîÎ≤ÑÍ∑∏ Ìï®ÏàòÎì§
function debugPoll(pollId) {
    console.log('Poll Debug:', polls.find(p => p.id === pollId));
}

function resetPolls() {
    polls.forEach(poll => {
        poll.hasVoted = false;
        poll.totalVotes = Math.floor(Math.random() * 30) + 10;
        poll.options.forEach(option => {
            option.votes = Math.floor(Math.random() * poll.totalVotes * 0.4);
            option.percentage = Math.round((option.votes / poll.totalVotes) * 100);
        });
    });
    console.log('Polls reset for testing');
}

// Ïï± Î≤ÑÏ†Ñ Ï†ïÎ≥¥
console.log('üéâ Circly App v1.0.0 - ÏùµÎ™Ö Ïπ≠Ï∞¨ Ìà¨Ìëú ÌîåÎû´Ìèº');